<!DOCTYPE html>
<html>
<head>
    <title>AI Assistant Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        #result { margin-top: 20px; padding: 10px; border: 1px solid #ddd; }
        .error { color: red; }
        .success { color: green; }
        input { width: 400px; padding: 10px; margin: 10px; }
    </style>
</head>
<body>
    <h1>AI Assistant Test</h1>
    
    <div id="auth-status" style="color: blue; margin-bottom: 10px;">Authenticating...</div>
    
    <input type="text" id="prompt" placeholder="Ask a brewing question..." value="What hops are best for IPA?">
    <button onclick="testAI()">Test AI Assistant</button>
    
    <div id="result"></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-functions-compat.js"></script>
    <script>
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDmvUqgMlnaQFiyqlo50D66fX0Bwav3j1k",
            authDomain: "brewmetrics-xyz-app-e8d51.firebaseapp.com",
            projectId: "brewmetrics-xyz-app-e8d51",
            storageBucket: "brewmetrics-xyz-app-e8d51.appspot.com",
            messagingSenderId: "391623246374",
            appId: "1:391623246374:web:3b8e39db5fff674befdce7"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Wait for auth to complete before enabling test
        let isAuthenticated = false;
        
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                console.log('User authenticated:', user.uid);
                isAuthenticated = true;
                document.getElementById('auth-status').textContent = 'Authenticated: ' + user.uid;
            } else {
                console.log('No user authenticated, signing in anonymously...');
                firebase.auth().signInAnonymously().catch(console.error);
            }
        });
        
        async function testAI() {
            const promptInput = document.getElementById('prompt');
            const resultDiv = document.getElementById('result');
            const prompt = promptInput.value.trim();
            
            if (!prompt) {
                resultDiv.innerHTML = '<div class="error">Please enter a question</div>';
                return;
            }
            
            if (!isAuthenticated) {
                resultDiv.innerHTML = '<div class="error">Please wait for authentication...</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div>Testing AI Assistant...</div>';
            
            try {
                console.log('Testing AI callable function...');
                
                // Use Firebase callable function
                const aiFunction = firebase.functions().httpsCallable('getAIBrewingAdvice');
                
                console.log('Calling function with prompt:', prompt);
                const result = await aiFunction({ prompt: prompt });
                
                console.log('Function result:', result);
                resultDiv.innerHTML = `<div class="success">
                    <strong>Success!</strong><br>
                    Response: ${result.data.response}
                </div>`;
                
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<div class="error">
                    <strong>Error:</strong> ${error.message}<br>
                    <strong>Code:</strong> ${error.code || 'Unknown'}<br>
                    <strong>Details:</strong> ${error.details || 'None'}
                </div>`;
            }
        }
        
        // Test on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded. Firebase initialized:', !!firebase.apps.length);
        });
    </script>
</body>
</html>